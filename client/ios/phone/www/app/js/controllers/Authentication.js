/**
 *
 * @author Schubert Generated Code</br>
 * Date Created: </br>
 * @since  </br>
 build:   </p>
 *
 * code was generated by the Schubert System </br>
 * Schubert system Copyright - NewPortBay LLC copy_right_range</br>
 * The generated code is free to use by anyone</p>
 *
 *
 *
 */

app.controller('Authentication', ['$scope', '$rootScope', '$location', '$state', '$window', '$q', '$http', '$ionicPopup', 'RestURL',  'Settings', 'surveyService','$timeout',
    function ($scope, $rootScope, $location, $state, $window, $q, $http, $ionicPopup, RestURL, Settings, surveyService,$timeout) {
        var self = $scope;
        self.userName = '';
        self.signIn = function (login) {
          console.log('Sign In');
             Settings.global.user = {};  
             var loginResult = [];
            //$state.go('app_level');
            var user = {
                "email": self.login.email,
                "passWord": self.login.password
            };
       
       loginResult =surveyService.login(user.email,user.passWord);            
        $timeout(function(){ 
            //console.log("loginResult----------"+angular.toJson(loginResult[0].Id));
            if(loginResult != null &&  loginResult != ''){
                Settings.global.user = {           
                    "Id":loginResult[0].Id,       
                    "username": loginResult[0].username,
                    "password": loginResult[0].password,
                    "email": loginResult[0].email
                };
                self.userName = Settings.global.user.username;
                console.log("succes"+angular.toJson(Settings.global.user));                 
                $state.go('app_level')     
            }else{
                   alert("fails login");

            }
        },900);            
           /* $http.post(RestURL.baseURL + 'login/loginValidation/', user)
                .success(function (data) {
                    console.log('hello friend');
                    console.log(data);
                    if (data.responseSuccess === 'success') {
                        Settings.global = data.result[0];
                        // redirect
                        $state.go('app_level');
                    } else {
                        $ionicPopup.alert({
                            title: 'Login Failed',
                            template: 'Invalid email or password'
                        });
                    }
                })
                .error(function (error) {
                    console.warn('Sign In failed');
                    console.warn(error);
                });*/
        };


        // Put this process inside a function
        // hard-coded

        self.emailAndPassword = function () {
         // clear old data
            Settings.global.user = {};

            // validation
            if (self.email && self.password) {
                console.log("------sing Up----user and password -------"+self.email +'----'+ self.password);
                // create new profile
                Settings.global.user = {           
                    "Id":"",       
                    "username": self.email,                    
                    "password": self.password,
                    "email": self.email
                };

                $timeout(function(){ 
                    //var singnResult=surveyService.getAllUser();                      
                    Settings.global.user.Id = null;
                   // console.log("-------------------size--"+Settings.global.user.Id);
                //console.log("singnResult-------pasword---"+Settings.global.user.Id+'--'+Settings.global.user.username+'--'+Settings.global.user.password+'----'+Settings.global.user.email);
                var singnResult=surveyService.createUser(Settings.global.user.Id,Settings.global.user.username,Settings.global.user.password,Settings.global.user.email);
                console.log("---ksvljnekls----"+angular.toJson($rootScope.userId));
                Settings.global.user.Id = singnResult ;
                if(singnResult != null &&  singnResult != ''){                                   
                        console.log("user created");
                         $state.go('app_level');
                }else{
                   alert("fails login");
                    }
                },900);
                // redirect
               // $state.go('organization');
            }
        };

        self.signUp = function () {
            var user;
            Settings.global.logged_in = true;
            user = {
                "details": "",
                "gender": Settings.global.gender,
                "name": "",
                "user": {
                    "organisation": Settings.global.organization,
                    "email": Settings.global.email,
                    "passWord": Settings.global.password,
                    "userType": "CUSTOMER",
                    "firstName": Settings.global.first_name,
                    "lastName": Settings.global.last_name,
                    "phoneNumber": Settings.global.phone_number
                }
            };

            console.log('CUSTOMER: ', user);

            $http.post(RestURL.baseURL + 'customer/create/', user)
                .success(function (data) {
                    console.log('CUSTOMER Created');
                    console.log(data);

                    // automatic sign in after registration
                    var user = {
                        "email": data.user.email,
                        "passWord": data.user.passWord
                    };

                    $http.post(RestURL.baseURL + 'login/loginValidation/', user)
                        .success(function (data) {
                            console.log(data);
                            if (data.responseSuccess === 'success') {
                                Settings.global = data.result[0];
                                // redirect
                                $state.go('profile');
                            } else {
                                $ionicPopup.alert({
                                    title: 'Login Failed',
                                    template: 'Invalid email or password'
                                });
                            }
                        })
                        .error(function (error) {
                            console.warn('Sign In failed');
                            console.warn(error);
                        });
                })
                .error(function (error) {
                    console.log('Sign Up failed');
                    console.warn(error);
                });

                
        };

        self.go = function (url) {
            $state.go(url);
        };

        self.showAlert = function (msg) {
            var alertPopup = $ionicPopup.alert({
                title: 'Result: ',
                template: msg
            });
            alertPopup.then(function (res) {
                console.log('Thanks');
            });
        };
                self.getRoute =function(){         
        };
        self.init = function(){
           console.log("------------------in getRoutes Method");
          // self.routesList = surveyService.getRoutes();
           //self.storeList=  surveyService.getStore();
           //console.log("------------------init route list"+angular.toJson(self.routesList));
        };

        //self.init();
    }]);